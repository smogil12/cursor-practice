<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tail AI Test Environment</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <!-- Custom CSS from Angular project -->
  <link href="./my-task.style.min.css" rel="stylesheet">
  <style>
    /* Optionally override or add custom styles here */
    body { font-family: 'Open Sans', Arial, sans-serif; }
  </style>
</head>
<body data-mytask="theme-indigo">
  <div id="login-section" style="display:none; max-width:400px; margin:40px auto; background:#fff; padding:32px; border-radius:8px; box-shadow:0 2px 8px #0001;">
    <h2>Login</h2>
    <form id="login-form">
      <input type="text" id="login-username" placeholder="Username" required style="width:100%;margin-bottom:8px;padding:8px;" />
      <input type="password" id="login-password" placeholder="Password" required style="width:100%;margin-bottom:8px;padding:8px;" />
      <button type="submit" style="width:100%;padding:8px;">Login</button>
    </form>
    <div id="login-error" style="color:red;margin-top:8px;"></div>
  </div>
  <div id="app-ui" style="display:none;">
    <div class="role-btns">
      <span>Switch Role: </span>
      <button onclick="setRole('ROLE_MANAGER')">Manager</button>
      <button onclick="setRole('ROLE_ADMIN')">Admin</button>
      <button onclick="setRole('ROLE_EMPLOYEE')">Employee</button>
      <button id="logout-btn" style="float:right;">Logout</button>
    </div>
    <div id="mytask-layout">
      <div id="sidebar" class="sidebar"></div>
      <div style="flex:1; display:flex; flex-direction:column;">
        <div id="header" class="header"></div>
        <div class="main">
          <h2>Welcome to Tail AI Test Environment</h2>
          <div id="main-content">Select a role to see the sidebar and header change.</div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // --- Role-based UI logic ---
    const sidebar = document.getElementById('sidebar');
    const header = document.getElementById('header');
    const mainContent = document.getElementById('main-content');
    const ROLE_KEY = 'tailai_test_role';

    function getRole() {
      return localStorage.getItem(ROLE_KEY) || '';
    }
    function setRole(role) {
      localStorage.setItem(ROLE_KEY, role);
      renderUI();
    }

    function renderSidebar(role) {
      if (role === 'ROLE_MANAGER') {
        sidebar.innerHTML = `<h2>Manager Sidebar</h2><ul><li>Dashboard</li><li>Team</li><li>Reports</li></ul>`;
      } else if (role === 'ROLE_ADMIN') {
        sidebar.innerHTML = `<h2>Admin Sidebar</h2><ul><li>Admin Panel</li><li>Users</li><li>Settings</li></ul>`;
      } else if (role === 'ROLE_EMPLOYEE') {
        sidebar.innerHTML = `<h2>Employee Sidebar</h2><ul><li>My Tasks</li><li>Profile</li></ul>`;
      } else {
        sidebar.innerHTML = '';
      }
    }
    function renderHeader(role) {
      if (role === 'ROLE_MANAGER') {
        header.textContent = 'Manager Header';
      } else if (role === 'ROLE_ADMIN') {
        header.textContent = 'Admin Header';
      } else if (role === 'ROLE_EMPLOYEE') {
        header.textContent = 'Employee Header';
      } else {
        header.textContent = '';
      }
    }
    function renderUI() {
      const role = getRole();
      if (role) {
        sidebar.style.display = '';
        header.style.display = '';
        renderSidebar(role);
        renderHeader(role);
        renderApp();
      } else {
        sidebar.style.display = 'none';
        header.style.display = 'none';
        mainContent.innerHTML = '<p>Please select a role above.</p>';
      }
    }

    // --- Auth Logic ---
    let currentUser = null;
    function getUserKey(username) { return `tailai_test_data_${username}`; }
    function getUserPasswordKey(username) { return `tailai_test_pw_${username}`; }
    function saveUserData() {
      if (currentUser) localStorage.setItem(getUserKey(currentUser), JSON.stringify(appData));
    }
    function loadUserData() {
      if (currentUser) {
        const raw = localStorage.getItem(getUserKey(currentUser));
        if (raw) {
          try { appData = JSON.parse(raw); } catch { appData = { clients: [] }; }
        } else {
          appData = { clients: [] };
        }
      }
    }
    function savePassword(username, password) {
      localStorage.setItem(getUserPasswordKey(username), password);
    }
    function getPassword(username) {
      return localStorage.getItem(getUserPasswordKey(username));
    }
    function showLogin() {
      document.getElementById('login-section').style.display = '';
      document.getElementById('app-ui').style.display = 'none';
      document.getElementById('login-error').textContent = '';
    }
    function showApp() {
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('app-ui').style.display = '';
    }
    function logout() {
      currentUser = null;
      sessionStorage.removeItem('tailai_test_user');
      showLogin();
    }
    function tryAutoLogin() {
      const user = sessionStorage.getItem('tailai_test_user');
      if (user) {
        currentUser = user;
        showApp();
        loadUserData();
        renderUI();
      } else {
        showLogin();
      }
    }
    document.getElementById('login-form').onsubmit = function(e) {
      e.preventDefault();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      if (!username || !password) {
        document.getElementById('login-error').textContent = 'Please enter username and password.';
        return;
      }
      const savedPassword = getPassword(username);
      if (savedPassword === null) {
        // New user, save password
        savePassword(username, password);
      } else if (savedPassword !== password) {
        document.getElementById('login-error').textContent = 'Incorrect password.';
        return;
      }
      currentUser = username;
      sessionStorage.setItem('tailai_test_user', username);
      showApp();
      loadUserData();
      renderUI();
      document.getElementById('login-form').reset();
    };
    document.getElementById('logout-btn').onclick = function() { logout(); };

    // --- Data Model & Storage (per user) ---
    const DATA_KEY = 'tailai_test_data';
    let appData = { clients: [] };
    function saveData() { saveUserData(); }
    function loadData() { loadUserData(); }
    loadData();

    // --- State ---
    let selectedClientIdx = null;
    let selectedProjectIdx = null;

    // --- Render Functions ---
    function renderApp() {
      if (selectedClientIdx === null) {
        renderClientsView();
      } else if (selectedProjectIdx === null) {
        renderProjectsView();
      } else {
        renderTasksView();
      }
    }
    function renderClientsView() {
      let html = `<h3>Clients</h3><ul>`;
      appData.clients.forEach((client, idx) => {
        html += `<li style='margin-bottom:8px;'>
          <span style='cursor:pointer;' onclick='selectClient(${idx})'><b>${client.name}</b></span>
          <button onclick='deleteClient(${idx})' style='margin-left:8px;'>Delete</button>
        </li>`;
      });
      html += `</ul>
        <form id='add-client-form'>
          <input type='text' id='client-name-input' placeholder='Add new client' required />
          <button type='submit'>Add Client</button>
        </form>`;
      mainContent.innerHTML = html;
      document.getElementById('add-client-form').onsubmit = function(e) {
        e.preventDefault();
        const name = document.getElementById('client-name-input').value.trim();
        if (name) {
          appData.clients.push({ name, projects: [] });
          saveData();
          renderClientsView();
        }
      };
    }
    function renderProjectsView() {
      const client = appData.clients[selectedClientIdx];
      let html = `<button onclick='backToClients()'>Back to Clients</button>`;
      html += `<h3>Projects for ${client.name}</h3><ul>`;
      client.projects.forEach((project, idx) => {
        const total = typeof project.hours === 'number' ? project.hours : 0;
        const spent = (project.tasks || []).reduce((sum, t) => sum + (typeof t.hours === 'number' ? t.hours : 0), 0);
        const remaining = Math.max(0, total - spent);
        html += `<li style='margin-bottom:8px;'>
          <span style='cursor:pointer;' onclick='selectProject(${idx})'><b>${project.name}</b> (Total: ${total}h, Remaining: ${remaining}h)</span>
          <button onclick='deleteProject(${idx})' style='margin-left:8px;'>Delete</button>
        </li>`;
      });
      html += `</ul>
        <form id='add-project-form'>
          <input type='text' id='project-name-input' placeholder='Add new project' required />
          <input type='number' id='project-hours-input' placeholder='Total hours' min='0' step='0.1' required />
          <button type='submit'>Add Project</button>
        </form>`;
      mainContent.innerHTML = html;
      document.getElementById('add-project-form').onsubmit = function(e) {
        e.preventDefault();
        const name = document.getElementById('project-name-input').value.trim();
        const hours = parseFloat(document.getElementById('project-hours-input').value);
        if (name && !isNaN(hours)) {
          client.projects.push({ name, hours, tasks: [] });
          saveData();
          renderProjectsView();
        }
      };
    }
    function renderTasksView() {
      const client = appData.clients[selectedClientIdx];
      const project = client.projects[selectedProjectIdx];
      let html = `<button onclick='backToProjects()'>Back to Projects</button>`;
      html += `<h3>Tasks for ${project.name}</h3><ul>`;
      project.tasks.forEach((task, idx) => {
        html += `<li style='margin-bottom:8px;'>
          <span><b>${task.desc}</b> (Assigned to: ${task.assignee}, Time spent: ${task.hours ?? 0}h)</span>
          <button onclick='deleteTask(${idx})' style='margin-left:8px;'>Delete</button>
        </li>`;
      });
      html += `</ul>
        <form id='add-task-form'>
          <input type='text' id='task-desc-input' placeholder='Add new task' required />
          <input type='text' id='task-assignee-input' placeholder='Assign to (name)' required />
          <input type='number' id='task-hours-input' placeholder='Time spent (hours)' min='0' step='0.1' required />
          <button type='submit'>Add Task</button>
        </form>`;
      mainContent.innerHTML = html;
      document.getElementById('add-task-form').onsubmit = function(e) {
        e.preventDefault();
        const desc = document.getElementById('task-desc-input').value.trim();
        const assignee = document.getElementById('task-assignee-input').value.trim();
        const hours = parseFloat(document.getElementById('task-hours-input').value);
        if (desc && assignee && !isNaN(hours)) {
          project.tasks.push({ desc, assignee, hours });
          saveData();
          renderTasksView();
        }
      };
    }
    // --- Navigation Functions ---
    window.selectClient = function(idx) {
      selectedClientIdx = idx;
      selectedProjectIdx = null;
      renderApp();
    };
    window.deleteClient = function(idx) {
      if (confirm('Delete this client?')) {
        appData.clients.splice(idx, 1);
        saveData();
        selectedClientIdx = null;
        renderApp();
      }
    };
    window.backToClients = function() {
      selectedClientIdx = null;
      selectedProjectIdx = null;
      renderApp();
    };
    window.selectProject = function(idx) {
      selectedProjectIdx = idx;
      renderApp();
    };
    window.deleteProject = function(idx) {
      if (confirm('Delete this project?')) {
        appData.clients[selectedClientIdx].projects.splice(idx, 1);
        saveData();
        selectedProjectIdx = null;
        renderApp();
      }
    };
    window.backToProjects = function() {
      selectedProjectIdx = null;
      renderApp();
    };
    window.deleteTask = function(idx) {
      if (confirm('Delete this task?')) {
        appData.clients[selectedClientIdx].projects[selectedProjectIdx].tasks.splice(idx, 1);
        saveData();
        renderTasksView();
      }
    };
    // Initial render
    tryAutoLogin();
  </script>
</body>
</html> 