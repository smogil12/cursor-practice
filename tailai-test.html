<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tail AI Test Environment</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <!-- Custom CSS from Angular project -->
  <link href="./my-task.style.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Open Sans', Arial, sans-serif; }
    .main-content-card { border-radius: 30px; background: #fff; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2); padding: 2rem; margin-top: 2rem; }
    .sidebar .logo-icon { width: 40px; height: 40px; }
    .sidebar .logo-text { font-size: 1.3rem; font-weight: 700; margin-left: 0.5rem; }
    .sidebar .menu-list { padding-left: 0; }
    .sidebar .menu-list li { list-style: none; margin-bottom: 1rem; }
    .sidebar .m-link { display: flex; align-items: center; color: #22223b; text-decoration: none; font-weight: 500; }
    .sidebar .m-link.active, .sidebar .m-link:hover { color: #0d6efd; }
    .sidebar .m-link i { margin-right: 0.75rem; font-size: 1.2rem; }
    .header .navbar { background: #fff; border-radius: 0 0 30px 30px; box-shadow: 0 2px 8px 0 rgba(0,0,0,0.05); }
    .header .user-profile img { border-radius: 12px; max-width: 40px; }
    .header .u-info { min-width: 100px; }
    .main-content-card h2 { margin-bottom: 1.5rem; }
    .table th, .table td { vertical-align: middle; }
    .btn { border-radius: 8px; }
    .form-control { border-radius: 8px; }
    .role-btns { margin: 16px 0; }
    .role-btns button { margin-right: 8px; }
    .hidden { display: none; }
  </style>
</head>
<body data-mytask="theme-indigo">
  <div id="login-section" style="display:none; max-width:400px; margin:40px auto; background:#fff; padding:32px; border-radius:8px; box-shadow:0 2px 8px #0001;">
    <h2>Login</h2>
    <form id="login-form">
      <input type="text" id="login-username" placeholder="Username" required class="form-control mb-2" />
      <input type="password" id="login-password" placeholder="Password" required class="form-control mb-2" />
      <button type="submit" class="btn btn-primary w-100">Login</button>
    </form>
    <div id="login-error" style="color:red;margin-top:8px;"></div>
  </div>
  <div id="app-ui" style="display:none;">
    <div class="role-btns container-fluid d-flex align-items-center justify-content-between mt-3">
      <div>
        <span>Switch Role: </span>
        <button onclick="setRole('ROLE_MANAGER')" class="btn btn-outline-primary btn-sm">Manager</button>
        <button onclick="setRole('ROLE_ADMIN')" class="btn btn-outline-secondary btn-sm">Admin</button>
        <button onclick="setRole('ROLE_EMPLOYEE')" class="btn btn-outline-success btn-sm">Employee</button>
      </div>
      <button id="logout-btn" class="btn btn-danger btn-sm">Logout</button>
    </div>
    <div id="mytask-layout" class="d-flex" style="min-height: 100vh;">
      <div id="sidebar" class="sidebar px-4 py-4 py-md-5 me-0"></div>
      <div class="flex-grow-1 d-flex flex-column">
        <div id="header" class="header"></div>
        <div class="main-content-card flex-grow-1">
          <div id="main-content"></div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // --- Role-based UI logic ---
    const sidebar = document.getElementById('sidebar');
    const header = document.getElementById('header');
    const mainContent = document.getElementById('main-content');
    const ROLE_KEY = 'tailai_test_role';

    function getRole() {
      return localStorage.getItem(ROLE_KEY) || '';
    }
    function setRole(role) {
      localStorage.setItem(ROLE_KEY, role);
      renderUI();
    }

    function renderSidebar(role) {
      if (role === 'ROLE_MANAGER') {
        sidebar.innerHTML = `<h2>Manager Sidebar</h2><ul><li>Dashboard</li><li>Team</li><li>Reports</li></ul>`;
      } else if (role === 'ROLE_ADMIN') {
        sidebar.innerHTML = `<h2>Admin Sidebar</h2><ul><li>Admin Panel</li><li>Users</li><li>Settings</li></ul>`;
      } else if (role === 'ROLE_EMPLOYEE') {
        sidebar.innerHTML = `<h2>Employee Sidebar</h2><ul><li>My Tasks</li><li>Profile</li></ul>`;
      } else {
        sidebar.innerHTML = '';
      }
    }
    function renderHeader(role) {
      if (role === 'ROLE_MANAGER') {
        header.textContent = 'Manager Header';
      } else if (role === 'ROLE_ADMIN') {
        header.textContent = 'Admin Header';
      } else if (role === 'ROLE_EMPLOYEE') {
        header.textContent = 'Employee Header';
      } else {
        header.textContent = '';
      }
    }
    function renderUI() {
      const role = getRole();
      if (role) {
        sidebar.style.display = '';
        header.style.display = '';
        renderSidebar(role);
        renderHeader(role);
        renderApp();
      } else {
        sidebar.style.display = 'none';
        header.style.display = 'none';
        mainContent.innerHTML = '<p>Please select a role above.</p>';
      }
    }

    // --- Auth Logic ---
    let currentUser = null;
    function getUserKey(username) { return `tailai_test_data_${username}`; }
    function getUserPasswordKey(username) { return `tailai_test_pw_${username}`; }
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await window.crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }
    async function savePassword(username, password) {
      const hash = await hashPassword(password);
      localStorage.setItem(getUserPasswordKey(username), hash);
    }
    function getPassword(username) {
      return localStorage.getItem(getUserPasswordKey(username));
    }
    function saveUserData() {
      if (currentUser) localStorage.setItem(getUserKey(currentUser), JSON.stringify(appData));
    }
    function loadUserData() {
      if (currentUser) {
        const raw = localStorage.getItem(getUserKey(currentUser));
        if (raw) {
          try { appData = JSON.parse(raw); } catch { appData = { clients: [] }; }
        } else {
          appData = { clients: [] };
        }
      }
    }
    function showLogin() {
      document.getElementById('login-section').style.display = '';
      document.getElementById('app-ui').style.display = 'none';
      document.getElementById('login-error').textContent = '';
    }
    function showApp() {
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('app-ui').style.display = '';
    }
    function logout() {
      currentUser = null;
      sessionStorage.removeItem('tailai_test_user');
      showLogin();
    }
    function tryAutoLogin() {
      const user = sessionStorage.getItem('tailai_test_user');
      if (user) {
        currentUser = user;
        showApp();
        loadUserData();
        renderUI();
      } else {
        showLogin();
      }
    }
    document.getElementById('login-form').onsubmit = async function(e) {
      e.preventDefault();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      if (!username || !password) {
        document.getElementById('login-error').textContent = 'Please enter username and password.';
        return;
      }
      if (username.length < 3 || /\s/.test(username)) {
        document.getElementById('login-error').textContent = 'Username must be at least 3 characters and contain no spaces.';
        return;
      }
      if (password.length < 8) {
        document.getElementById('login-error').textContent = 'Password must be at least 8 characters.';
        return;
      }
      const savedPasswordHash = getPassword(username);
      const enteredPasswordHash = await hashPassword(password);
      if (savedPasswordHash === null) {
        // New user, save password hash
        await savePassword(username, password);
      } else if (savedPasswordHash !== enteredPasswordHash) {
        document.getElementById('login-error').textContent = 'Incorrect password.';
        return;
      }
      currentUser = username;
      sessionStorage.setItem('tailai_test_user', username);
      showApp();
      loadUserData();
      renderUI();
      document.getElementById('login-form').reset();
    };
    document.getElementById('logout-btn').onclick = function() { logout(); };

    // --- Data Model & Storage (per user) ---
    const DATA_KEY = 'tailai_test_data';
    let appData = { clients: [] };
    function saveData() { saveUserData(); }
    function loadData() { loadUserData(); }
    loadData();

    // --- State ---
    let selectedClientIdx = null;
    let selectedProjectIdx = null;

    // --- Render Functions ---
    function formatMinutes(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return `${h}h ${m}m`;
    }
    function renderApp() {
      if (selectedClientIdx === null) {
        renderClientsView();
      } else if (selectedProjectIdx === null) {
        renderProjectsView();
      } else {
        renderTasksView();
      }
    }
    function renderClientsView() {
      let html = `
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Clients</h5>
            <button class="btn btn-success btn-sm" data-bs-toggle="collapse" data-bs-target="#addClientCollapse">Add Client</button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr><th>Name</th><th style="width:120px;">Actions</th></tr>
                </thead>
                <tbody>`;
      appData.clients.forEach((client, idx) => {
        html += `<tr>
          <td><a href="#" onclick="selectClient(${idx})" class="fw-bold text-decoration-none">${client.name}</a></td>
          <td>
            <button onclick="selectClient(${idx})" class="btn btn-primary btn-sm me-1"><i class="bi bi-folder2-open"></i></button>
            <button onclick="deleteClient(${idx})" class="btn btn-danger btn-sm"><i class="bi bi-trash"></i></button>
          </td>
        </tr>`;
      });
      html += `</tbody></table></div>
            <div class="collapse mt-3" id="addClientCollapse">
              <form id="add-client-form" class="row g-2 align-items-center">
                <div class="col-auto flex-grow-1">
                  <input type="text" id="client-name-input" class="form-control" placeholder="Add new client" required />
                </div>
                <div class="col-auto">
                  <button type="submit" class="btn btn-success">Add Client</button>
                </div>
              </form>
            </div>
          </div>
        </div>`;
      mainContent.innerHTML = html;
      document.getElementById('add-client-form').onsubmit = function(e) {
        e.preventDefault();
        const name = document.getElementById('client-name-input').value.trim();
        if (name) {
          appData.clients.push({ name, projects: [] });
          saveData();
          renderClientsView();
        }
      };
    }
    function renderProjectsView() {
      const client = appData.clients[selectedClientIdx];
      let html = `
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <div>
              <button onclick="backToClients()" class="btn btn-outline-light btn-sm me-2"><i class="bi bi-arrow-left"></i></button>
              <span>Projects for <b>${client.name}</b></span>
            </div>
            <button class="btn btn-success btn-sm" data-bs-toggle="collapse" data-bs-target="#addProjectCollapse">Add Project</button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr><th>Name</th><th>Total Time</th><th>Remaining</th><th style="width:120px;">Actions</th></tr>
                </thead>
                <tbody>`;
      client.projects.forEach((project, idx) => {
        const total = typeof project.totalMinutes === 'number' ? project.totalMinutes : 0;
        const spent = (project.tasks || []).reduce((sum, t) => {
          return sum + (t.status === 'complete' ? (typeof t.actualMinutes === 'number' ? t.actualMinutes : 0) : 0);
        }, 0);
        const remaining = Math.max(0, total - spent);
        html += `<tr>
          <td><a href="#" onclick="selectProject(${idx})" class="fw-bold text-decoration-none">${project.name}</a></td>
          <td>${formatMinutes(total)}</td>
          <td>${formatMinutes(remaining)}</td>
          <td>
            <button onclick="selectProject(${idx})" class="btn btn-primary btn-sm me-1"><i class="bi bi-folder2-open"></i></button>
            <button onclick="deleteProject(${idx})" class="btn btn-danger btn-sm"><i class="bi bi-trash"></i></button>
          </td>
        </tr>`;
      });
      html += `</tbody></table></div>
            <div class="collapse mt-3" id="addProjectCollapse">
              <form id="add-project-form" class="row g-2 align-items-center">
                <div class="col-auto flex-grow-1">
                  <input type="text" id="project-name-input" class="form-control" placeholder="Add new project" required />
                </div>
                <div class="col-auto">
                  <input type="number" id="project-hours-input" class="form-control" placeholder="Hours" min="0" step="1" required />
                </div>
                <div class="col-auto">
                  <input type="number" id="project-mins-input" class="form-control" placeholder="Minutes" min="0" max="59" step="1" value="0" required />
                </div>
                <div class="col-auto">
                  <button type="submit" class="btn btn-success">Add Project</button>
                </div>
              </form>
            </div>
          </div>
        </div>`;
      mainContent.innerHTML = html;
      document.getElementById('add-project-form').onsubmit = function(e) {
        e.preventDefault();
        const name = document.getElementById('project-name-input').value.trim();
        const hours = parseInt(document.getElementById('project-hours-input').value, 10) || 0;
        const mins = parseInt(document.getElementById('project-mins-input').value, 10) || 0;
        const totalMinutes = hours * 60 + mins;
        if (name && totalMinutes > 0) {
          client.projects.push({ name, totalMinutes, tasks: [] });
          saveData();
          renderProjectsView();
        }
      };
    }
    function renderTasksView() {
      const client = appData.clients[selectedClientIdx];
      const project = client.projects[selectedProjectIdx];
      let html = `
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <div>
              <button onclick="backToProjects()" class="btn btn-outline-light btn-sm me-2"><i class="bi bi-arrow-left"></i></button>
              <span>Tasks for <b>${project.name}</b></span>
            </div>
            <button class="btn btn-success btn-sm" data-bs-toggle="collapse" data-bs-target="#addTaskCollapse">Add Task</button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr><th>Description</th><th>Assignee</th><th>Estimated Time</th><th>Actual Time</th><th>Status</th><th style="width:120px;">Actions</th></tr>
                </thead>
                <tbody>`;
      project.tasks.forEach((task, idx) => {
        const statusClass = task.status === 'complete' ? 'badge bg-success' : 
                          task.status === 'in progress' ? 'badge bg-warning' : 'badge bg-secondary';
        const actualTime = task.actualMinutes ? formatMinutes(task.actualMinutes) : '-';
        html += `<tr>
          <td>${task.desc}</td>
          <td>${task.assignee}</td>
          <td>${formatMinutes(task.estimatedMinutes ?? 0)}</td>
          <td>${actualTime}</td>
          <td><span class="${statusClass}">${task.status || 'todo'}</span></td>
          <td>
            <button onclick="changeTaskStatus(${idx})" class="btn btn-info btn-sm me-1"><i class="bi bi-pencil"></i></button>
            <button onclick="deleteTask(${idx})" class="btn btn-danger btn-sm"><i class="bi bi-trash"></i></button>
          </td>
        </tr>`;
      });
      html += `</tbody></table></div>
            <div class="collapse mt-3" id="addTaskCollapse">
              <form id="add-task-form" class="row g-2 align-items-center">
                <div class="col-auto flex-grow-1">
                  <input type="text" id="task-desc-input" class="form-control" placeholder="Add new task" required />
                </div>
                <div class="col-auto">
                  <input type="text" id="task-assignee-input" class="form-control" placeholder="Assign to (name)" required />
                </div>
                <div class="col-auto">
                  <input type="number" id="task-hours-input" class="form-control" placeholder="Est. Hours" min="0" step="1" required />
                </div>
                <div class="col-auto">
                  <input type="number" id="task-mins-input" class="form-control" placeholder="Est. Minutes" min="0" max="59" step="1" value="0" required />
                </div>
                <div class="col-auto">
                  <select id="task-status-input" class="form-control">
                    <option value="todo">Todo</option>
                    <option value="in progress">In Progress</option>
                  </select>
                </div>
                <div class="col-auto">
                  <button type="submit" class="btn btn-success">Add Task</button>
                </div>
              </form>
            </div>
          </div>
        </div>`;
      mainContent.innerHTML = html;
      document.getElementById('add-task-form').onsubmit = function(e) {
        e.preventDefault();
        const desc = document.getElementById('task-desc-input').value.trim();
        const assignee = document.getElementById('task-assignee-input').value.trim();
        const hours = parseInt(document.getElementById('task-hours-input').value, 10) || 0;
        const mins = parseInt(document.getElementById('task-mins-input').value, 10) || 0;
        const estimatedMinutes = hours * 60 + mins;
        const status = document.getElementById('task-status-input').value;
        if (desc && assignee && estimatedMinutes > 0) {
          project.tasks.push({ 
            desc, 
            assignee, 
            estimatedMinutes, 
            status,
            createdAt: new Date().toISOString() // Store creation timestamp
          });
          saveData();
          renderTasksView();
        }
      };
    }
    // --- Navigation Functions ---
    window.selectClient = function(idx) {
      selectedClientIdx = idx;
      selectedProjectIdx = null;
      renderApp();
    };
    window.deleteClient = function(idx) {
      if (confirm('Delete this client?')) {
        appData.clients.splice(idx, 1);
        saveData();
        selectedClientIdx = null;
        renderApp();
      }
    };
    window.backToClients = function() {
      selectedClientIdx = null;
      selectedProjectIdx = null;
      renderApp();
    };
    window.selectProject = function(idx) {
      selectedProjectIdx = idx;
      renderApp();
    };
    window.deleteProject = function(idx) {
      if (confirm('Delete this project?')) {
        appData.clients[selectedClientIdx].projects.splice(idx, 1);
        saveData();
        selectedProjectIdx = null;
        renderApp();
      }
    };
    window.backToProjects = function() {
      selectedProjectIdx = null;
      renderApp();
    };
    window.deleteTask = function(idx) {
      if (confirm('Delete this task?')) {
        appData.clients[selectedClientIdx].projects[selectedProjectIdx].tasks.splice(idx, 1);
        saveData();
        renderTasksView();
      }
    };
    window.changeTaskStatus = function(idx) {
      const task = appData.clients[selectedClientIdx].projects[selectedProjectIdx].tasks[idx];
      
      // Calculate AI estimated time if task has creation timestamp
      let aiEstimatedTime = null;
      if (task.createdAt) {
        const createdTime = new Date(task.createdAt);
        const currentTime = new Date();
        const timeDiffMs = currentTime - createdTime;
        const timeDiffMinutes = Math.round(timeDiffMs / (1000 * 60));
        aiEstimatedTime = timeDiffMinutes;
        console.log('AI Estimation Debug:', {
          createdAt: task.createdAt,
          createdTime: createdTime,
          currentTime: currentTime,
          timeDiffMs: timeDiffMs,
          timeDiffMinutes: timeDiffMinutes
        });
      }
      
      // Create modal HTML
      const modalHtml = `
        <div class="modal fade" id="statusModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Change Task Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <p><strong>Task:</strong> ${task.desc}</p>
                <p><strong>Estimated Time:</strong> ${formatMinutes(task.estimatedMinutes ?? 0)}</p>
                ${aiEstimatedTime ? `<p><strong>AI Estimated Time:</strong> <span class="text-info">${formatMinutes(aiEstimatedTime)}</span> (based on creation time)</p>` : ''}
                <label for="statusSelect" class="form-label">Select Status:</label>
                <select id="statusSelect" class="form-select mb-3">
                  <option value="todo" ${task.status === 'todo' ? 'selected' : ''}>Todo</option>
                  <option value="in progress" ${task.status === 'in progress' ? 'selected' : ''}>In Progress</option>
                  <option value="complete" ${task.status === 'complete' ? 'selected' : ''}>Complete</option>
                </select>
                <div id="actualTimeSection" style="display: none;">
                  <label for="actualHours" class="form-label">Actual Time Spent:</label>
                  <div class="row g-2 mb-2">
                    <div class="col">
                      <input type="number" id="actualHours" class="form-control" placeholder="Hours" min="0" step="1" />
                    </div>
                    <div class="col">
                      <input type="number" id="actualMinutes" class="form-control" placeholder="Minutes" min="0" max="59" step="1" />
                    </div>
                  </div>
                  ${aiEstimatedTime ? `<button type="button" class="btn btn-outline-info btn-sm" onclick="useAIEstimate(${aiEstimatedTime})">Use AI Estimate (${formatMinutes(aiEstimatedTime)})</button>` : ''}
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTaskStatus(${idx})">Save Changes</button>
              </div>
            </div>
          </div>
        </div>`;
      
      // Remove existing modal if any
      const existingModal = document.getElementById('statusModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('statusModal'));
      modal.show();
      
      // Show/hide actual time section based on status
      document.getElementById('statusSelect').addEventListener('change', function() {
        const actualTimeSection = document.getElementById('actualTimeSection');
        if (this.value === 'complete') {
          actualTimeSection.style.display = 'block';
        } else {
          actualTimeSection.style.display = 'none';
        }
      });
    };
    
    window.useAIEstimate = function(minutes) {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      document.getElementById('actualHours').value = hours;
      document.getElementById('actualMinutes').value = mins;
    };
    
    window.saveTaskStatus = function(idx) {
      const newStatus = document.getElementById('statusSelect').value;
      const task = appData.clients[selectedClientIdx].projects[selectedProjectIdx].tasks[idx];
      task.status = newStatus;
      
      // If marking as complete, get actual time and store completion timestamp
      if (newStatus === 'complete') {
        const actualHours = parseInt(document.getElementById('actualHours').value, 10) || 0;
        const actualMins = parseInt(document.getElementById('actualMinutes').value, 10) || 0;
        task.actualMinutes = actualHours * 60 + actualMins;
        task.completedAt = new Date().toISOString(); // Store completion timestamp
      }
      
      saveData();
      renderTasksView();
      
      // Hide modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('statusModal'));
      modal.hide();
    };
    // Initial render
    tryAutoLogin();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 